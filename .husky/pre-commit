#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸš€ Running pre-commit checks..."

if git diff --cached --name-only | grep -q "^api/"; then
  echo "ğŸ“¦ API changes detected, running API checks..."
  cd api

  # Run Build
  echo "ğŸ› ï¸ Building API code..."
  cargo build
  if [ $? -ne 0 ]; then
    echo "âŒ API build failed"
    exit 1
  fi

  cd ..
fi

# Check if we're in Web directory or have Web changes
if git diff --cached --name-only | grep -q "^web/"; then
  echo "ğŸŒ Web changes detected, running Web checks..."
  cd web

  # Format
  echo "ğŸ“ Formatting Web code..."
  pnpm format
  if [ $? -ne 0 ]; then
    echo "âŒ Web formatting failed"
    exit 1
  fi

  # Run Check
  echo "ğŸ” Checking Web code..."
  pnpm check
  if [ $? -ne 0 ]; then
    echo "âŒ Web checks failed"
    exit 1
  fi

  # Run linting
  echo "ğŸ” Linting Web code..."
  pnpm lint
  if [ $? -ne 0 ]; then
    echo "âŒ Web linting failed"
    exit 1
  fi
  
  # Run type checking
  echo "ğŸ”§ Type checking..."
  pnpm check:types
  if [ $? -ne 0 ]; then
    echo "âŒ Type checking failed"
    exit 1
  fi

  # Run Build
  echo "ğŸ› ï¸ Building Web code..."
  pnpm build
  if [ $? -ne 0 ]; then
    echo "âŒ Web build failed"
    exit 1
  fi

  cd ..
fi

echo "âœ… Pre-commit checks passed!"